<!DOCTYPE html>
<html>
<head>
  <title>Dynamic Incident Map</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style> body { margin:0; padding:0; } #map { height:100vh; width:100%; } </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    function renderMap(data) {
      if (!data || !data.length) return;
      const { lat, long } = data[0];
      const map = L.map('map', { preferCanvas: true }).setView([lat, long], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
      data.forEach(({ state, lat, long, count }) => {
        L.circleMarker([lat, long], {
          radius: 5 + count / 10,
          color: 'blue',
          fillColor: '#0077ff',
          fillOpacity: 0.6
        }).addTo(map).bindPopup(`<b>${state}</b><br>Count: ${count}`);
      });
    }

    window.addEventListener("message", event => {
      const { state, lat, long, count } = event.data || {};
      if (!state || !lat) return;
      const dataset = state.map((s, i) => ({
        state: decodeURIComponent(s),
        lat: +lat[i],
        long: +long[i],
        count: +count[i]
      }));
      renderMap(dataset);
    });
  </script>
</body>
</html>
